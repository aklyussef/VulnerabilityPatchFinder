import os
import shutil

class IOHelper:

    def __init__(self):
        self.dir = os.getcwd()
        self.dir = os.path.join(self.dir,'repos')
        self.outdir = ""

    def getreposfromFile(self,filepath):
        print("Reading repo input file: {}".format(filepath))
        repolist = []
        if ( not os.path.exists(filepath)):
            print("File {} doesn't exist".format(filepath))
            exit(1)
        file = open(filepath,'r')
        filelines = file.readlines()
        for line in filelines:
            line = line.strip()
            if(line.startswith('http') and line.endswith('.git')):
                repolist.append(line)
            else:
                print("{} does not look like a repo...please check for next run".format(line))
        file.close()
        return repolist

    def getCurrentDirectory(self):
        return self.dir

    def getDirName(self, repoURL):
        #get url after https://github.com/
        url = repoURL.replace('.git','')
        urlParts = url.split('/')
        self.projectName = urlParts[-1]
        outdir = os.path.join(self.dir,self.projectName)
        return outdir

    def createRepoDirectory(self, outdir):
        #create dir for repo
        if((os.path.exists(outdir))):
            print("Directory already exists")
            return outdir
            #shutil.rmtree(outdir)
        print("Making Directory {}".format(outdir))
        os.makedirs(outdir)
        return outdir

    def createOutputDirectory(self):
        self.outdir = os.path.join(self.dir,"output")
        if (not (os.path.exists(self.outdir))):
            print("Creating output file directory")
            os.makedirs(self.outdir)
        return self.outdir

    def writeOutputHeader(self):
        self.createOutputDirectory()
        outfilePath = os.path.join(self.outdir,"scan_summary.csv")
        if( os.path.exists(outfilePath)):
            os.remove(outfilePath)
        self.outfile = open(outfilePath,'w+')
        self.outfile.write("Project Name, Repository, Commit ID, CVE ID, CVE Details\n")
        return

    def writeRepoFinds(self, resultList):
        print("Writing to output file...")
        if(len(resultList) == 0):
            return
        for key in resultList:
            self.outfile.write("{},{},{},{},,\n".format(
                self.projectName,resultList[key][0],key,resultList[key][1]))
        return

    def writeCVEentry(self,proj_url,commit,cve_entry):
        print("writing CVE entry")
        self.outfile.write("{},{},{},{},,\n".format(
            self.projectName,proj_url,commit,cve_entry))
        return


    def free_resources(self):
        self.outfile.close()


def main():
    print("Welcome to IOHelper Main")
    for i in range(1,10):
        print("i is: {}".format(i))
        for j in range(3,10):
            if(i == 3):
                break
            print("\tj is: {}".format(j))
    return
    m = IOHelper()
    print(m.createRepoDirectory(m.getCurrentDirectory(), r'https://github.com/aklyussef/VulnerableRepoTest.git'))

if __name__ == '__main__':
    main()