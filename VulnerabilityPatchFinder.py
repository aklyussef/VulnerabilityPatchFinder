import sys
from IOHelper import IOHelper
from GitHelper import GitHelper
import timeit


def main():

    if (len(sys.argv) != 2):
        print("USAGE: {} path/to/git/repo/file/toscan".format(sys.argv[0].split('/')[-1]))
        return

    IOhelper = IOHelper()

    repoList = IOhelper.getreposfromFile(sys.argv[1])
    IOhelper.createOutputDirectory()
    IOhelper.writeOutputHeader()

    for repoURL in repoList:
        print("Preparing to scan repo {}".format(repoURL))
        outDirName = IOhelper.getDirName(repoURL)
        gitHelper = GitHelper(repoURL)
        print("Creating necessary dirs")
        IOhelper.createRepoDirectory(outDirName)
        if not gitHelper.isgitRepo(outDirName):
            print("Cloning repository from {}".format(repoURL))
            gitHelper.cloneRepo(outDirName)
        else:
            # force fetch all from repo to ensure working with latest
            gitHelper.fetch_all()
        gitHelper.findFixCommits(IOhelper.writeCVEentry)
    IOhelper.free_resources()


if __name__ == '__main__':
    main()